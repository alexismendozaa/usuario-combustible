datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String   @unique
  passwordHash String
  name         String?
  isVerified   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  avatarKey    String?
  avatarUrl    String?

  EmailVerificationToken EmailVerificationToken[]
  PasswordResetToken     PasswordResetToken[]
  RefreshToken           RefreshToken[]
  vehicles               Vehicle[]
  refuels                Refuel[]
  maintenanceItems       MaintenanceItem[]
  maintenanceLogs        MaintenanceLog[]
}

model EmailVerificationToken {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @db.Uuid
  tokenHash String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetToken {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @db.Uuid
  tokenHash String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RefreshToken {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @db.Uuid
  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Vehicle {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @db.Uuid
  name       String
  brand      String?
  model      String?
  year       Int?
  plate      String?
  fuelType   String?
  odometerKm Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  refuels Refuel[]
  maintenanceItems MaintenanceItem[]
  maintenanceLogs  MaintenanceLog[]
  @@index([userId])
}

model Refuel {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @db.Uuid
  vehicleId  String    @db.Uuid


  filledAt   DateTime @default(now())
  odometerKm Int
  liters     Decimal
  totalCost  Decimal

  note       String?
  lat        Decimal?
  lng        Decimal?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([vehicleId])
  @@index([filledAt])
}

model MaintenanceItem {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @db.Uuid
  vehicleId         String  @db.Uuid

  title             String
  notes             String?

  intervalKm        Int?
  intervalMonths    Int?

  lastDoneAt        DateTime?
  lastDoneOdometerKm Int?

  nextDueAt         DateTime?
  nextDueOdometerKm Int?

  isActive          Boolean  @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  logs MaintenanceLog[]

  @@index([userId])
  @@index([vehicleId])
}

model MaintenanceLog {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @db.Uuid
  vehicleId         String  @db.Uuid
  maintenanceItemId String  @db.Uuid

  doneAt            DateTime @default(now())
  odometerKm        Int?
  cost              Decimal?
  note              String?

  createdAt         DateTime @default(now())

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  item    MaintenanceItem @relation(fields: [maintenanceItemId], references: [id], onDelete: Cascade)

  @@index([maintenanceItemId])
  @@index([vehicleId])
}
